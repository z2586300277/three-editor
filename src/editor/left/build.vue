<template>
    <div class="build">
        <div class="back" v-for="i in emitEditor.IndexDBList">
            <div class="item">
                <el-link @click="load(i.name, 'indexDB')">
                    本机: {{ sl(i.name) }}
                </el-link>
            </div>
        </div>
        <div class="back" v-for="i in data.list">
            <div class="item" draggable="true" @dragend="e => load(i.name, 'online', e)">
                <el-link @click="load(i.name)">
                    {{ i.name }}
                </el-link>
            </div>
        </div>
    </div>
</template>

<script setup>
import { Config, fetchResource } from '../config'
import { shallowReactive } from 'vue';
import { getObjectViews, createGsapAnimation, THREE } from 'three-editor-cores'
import { ElMessage } from 'element-plus'

const props = defineProps(['emitEditor'])

const sl = name => name.length > 20 ? name.slice(0, 20) + '...' : name

function load(name, t = 'online', event) {

    const type = name.split('.').pop().toUpperCase()

    let url

    if (t === 'online') url = Config.buildUrl + name

    else {

        const item = props.emitEditor.IndexDBList.find(i => i.name === name)

        if (item) url = URL.createObjectURL(item.blob)

        else return

    }

    if (!type) return

    if (!['FBX', 'GLB', 'GLTF', 'OBJ'].includes(type)) return

    const rootInfo = { url, type: type === 'GLB' ? 'GLTF' : type, indexDBNameUrl: t === 'indexDB' ? 'IndexDB:' + name : '' }

    const { loaderService } = props.emitEditor.threeEditor.modelCore.insertModel(rootInfo)

    props.emitEditor.loading = true

    setTimeout(() => {

        if (props.emitEditor.loading) {

            props.emitEditor.loading = false

            ElMessage.error('网络较差,加载比较缓慢')

        }

    }, 8000)

    loaderService.complete = m => {

        props.emitEditor.loading = false

        const { transformControls, camera, DOM, scene, controls } = props.emitEditor.threeEditor

        if (event)  {
        const { clientX, clientY } = event;
        const mouse = new THREE.Vector2();
        mouse.x = (clientX / DOM.clientWidth) * 2 - 1;
        mouse.y = -(clientY / DOM.clientHeight) * 2 + 1;
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(scene.children, true);
        if (intersects.length > 0) {
                const intersect = intersects[0];
                const { point } = intersect;
                if(point) m.position.copy(point);
           }
        }

        const { maxView, target } = getObjectViews(m)

        Promise.all([createGsapAnimation(camera.position, maxView), createGsapAnimation(controls.target, target)]).then(() => {

            props.emitEditor.threeEditor.setOutlinePass([m])

            controls.target.copy(target)

            transformControls.attach(m)

            setTimeout(() => props.emitEditor.threeEditor.setOutlinePass([]), 1000)

        })

    }

}

const data = shallowReactive({ list: [] })

fetchResource(Config.buildUrl).then(res => data.list = res?.map(i => ({ name: i, url: Config.buildUrl + i })))

</script>

<style lang="less" scoped>
.build {
    padding: 4px;
    box-sizing: border-box;
    display: grid;
    grid-template-rows: repeat(auto-fit, 80px);
    grid-template-columns: repeat(2, 1fr);
    overflow: scroll;
    height: 100%;
    justify-items: center;
    width: calc(100% - 60px);

    .back {
        height: 70px;
        width: 90px;
        border-radius: 6px;
        border: 1px solid #676768;
        display: flex;
        padding: 5px;
        box-sizing: border-box;
    }

    .item {
        border: 1px solid #3d3d3d;
        border-radius: 3px;
        height: 100%;
        width: 100%;
        word-wrap: break-word;
        word-break: break-all;
        font-size: 12px;
        display: flex;
        overflow-wrap: break-word;
        text-align: center;
        justify-content: center;
        align-content: center;
        justify-items: center;
        align-items: center;
        padding: 4px;
        box-sizing: border-box;
    }

}
</style>
